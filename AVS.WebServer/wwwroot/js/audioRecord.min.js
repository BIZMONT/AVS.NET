function configureMicrophone(){navigator.getUserMedia||(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia);navigator.getUserMedia?navigator.getUserMedia({audio:!0},getMediaCallback,function(){$("#status").html("Error capturing audio.")}):$("#status").html("getUserMedia not supported in this browser.")}function getMediaCallback(n){function i(){t.isRecording()||proceeding||($(".circle img").addClass("record"),proceeding=!0,audio.pause(),t.startRecording(),$("#status").html('Listerning<span class="dot">.<\/span><span class="dot">.<\/span><span class="dot">.<\/span>'))}function r(){t.isRecording()&&($(".circle img").removeClass("record"),$("#status").html("Hold Spacebar to say something to Alexa"),t.finishRecording())}var u=start_microphone(n),t=configureRecorder(u);$("#status").html("Hold spacebar to say something to Alexa");$(".circle.inner").on("touchstart",function(){i()});$(".circle.inner").on("touchend",function(){r()});$(document).keydown(function(n){n.which===32&&(n.preventDefault(),i())});$(document).keyup(function(n){n.which===32&&(n.preventDefault(),r())})}function start_microphone(n){var t=new AudioContext,i=t.createGain(),u,r;return i.gain.value=1,u=t.createMediaStreamSource(n),u.connect(i),r=t.createScriptProcessor(2048,1,1),i.connect(r),r.connect(t.destination),i}function process_microphone_buffer(n){var t=n.inputBuffer.getChannelData(0)}function configureRecorder(n){var t=new WebAudioRecorder(n,{workerDir:"js/"});return t.setOptions({timeLimit:60,encodeAfterRecord:!1,progressInterval:1e3,wav:{mimeType:"audio/wav"}}),t.onTimeout=function(n){n.finishRecording()},t.onComplete=function(n,t){sendAudioToServer(t)},t.onError=function(n,t){$("#status").html(t)},t}function sendAudioToServer(n){var i=(window.URL||window.webkitURL).createObjectURL(n),t=new FormData;t.append("fname","request.wav");t.append("audioRequest",n);$("#status").html('Waiting for response<span class="dot">.<\/span><span class="dot">.<\/span><span class="dot">.<\/span>');$.ajax({url:"avs/communicate",type:"POST",data:t,contentType:!1,processData:!1,complete:function(){proceeding=!1},success:proceedResponse,error:function(n){$("#status").html(n)}})}function proceedResponse(n){if(!n.error&&n.response)try{var i=b64toBlob(n.response,"audio/wav"),t=URL.createObjectURL(i);audio.src=t;audio.onload=function(){URL.revokeObjectUrl(t)};audio.addEventListener("ended",function(){$(".circle.outer").removeClass("play");$("#status").html("Hold spacebar to say something to Alexa")});audio.addEventListener("play",function(){$(".circle.outer").addClass("play")});audio.play()}catch(r){$(".circle.outer").removeClass("play");$("#status").html(r);return}$("#status").html(n.text)}function b64toBlob(n,t,i){var e,o,r,f,s,u,h;for(t=t||"",i=i||512,e=atob(n),o=[],r=0;r<e.length;r+=i){for(f=e.slice(r,r+i),s=new Array(f.length),u=0;u<f.length;u++)s[u]=f.charCodeAt(u);h=new Uint8Array(s);o.push(h)}return new Blob(o,{type:t})}var proceeding=!1,audio=document.getElementById("response")||new Audio;$(document).ready(function(){$("#status").html("Hold spacebar to say something to Alexa");configureMicrophone()});